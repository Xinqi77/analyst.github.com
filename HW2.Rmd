---
title: "HW2---Overbooking"
author: "Xinqi Zhang"
date: "1/18/2019"
output: html_document
---

```{r include=FALSE}
library(ggplot2)
library(tidyverse)
library(Hmisc)
library(forcats)
library(broom)

```


```{r}
data <- read.table('data.txt')
```

**1)What is their target service level? How many tickets should the Southwest book on its flight from San Diego to Boston based on the data? **

The amount of overbooking is similar to the amount of cupcakes. The number of people who didn't show up is similar to the demand for cupcakes. 

SL=  (Cost of Understock)/(Cost of Understock+Cost of Overstock)=600/(600+250)=70.588%

Thinking about a specific scenario: The number of cancellation is 10. 

**Perfect situation:** If Southwest booked 320 tickets, then all the customers can get their seats. 

**Overstock:** If Southwest booked 321 tickets, there will be one person who cannot get on the plane. So Southwest should compensate him 250 dollars and help them book another flight. So the cost of overstock is 250.

**Understock:** If Southwest booked 319 tickets, there will be one seat left empty. So the cost of understock is 600.

Southwest should satisfy 70.588% of the situations. From the data, we can get that for 72.33% of the case, there will be 14 or less cancellation. So Southwest should book 324 tickets.


```{r}
data_freq <- data%>%
  group_by(V1)%>%
  summarise(freq = n()/730)%>%
  mutate(cum_sum = cumsum(freq))
  
data_freq%>%
  mutate(Target_Service_Level = ifelse(cum_sum<0.70588, "Fail_to_meet", "Succeed_to_meet"))%>%
  ggplot(aes(x = V1, y = freq, fill = Target_Service_Level))+
  geom_bar(stat = "identity")+
  labs(title = "Frequency of cancellation over time", x = "Number of cancellation", y = "Frequency")
```

```{r}
index <- data_freq$cum_sum>0.70588
data_freq[index,]
```

We can see from the table and bar chart above that when number of cancellation is above 14, Southwest can meet their target service level. So they should book 324 tickets.

**2)	Suppose that the Oracle comes and provides the exact information about how many cancellations will be there. What is the value of an Oracle based on the data? **

We can use the data to calculate the expected profit of booking 324 tickets.

```{r}

data_profit <- data_freq%>%
  mutate(profit = 600*pmin(310, 324-V1)-pmax(324-V1-310, 0)*250)

total_exp_profit <- sum(data_profit$freq*data_profit$profit)
print(total_exp_profit)
```

The expected profit of booking 324 tickets is 184394.1. 

```{r}
WithOracle <- 310*600 
diff <- WithOracle - total_exp_profit
print(diff)

```

So the value of Oracle is just the difference, 1605.89. 

**3) Explore the correlation of the today’s cancellation and yesterday’s cancellation data. What is the correlation coefficient in the data? Improve your forecasting by predicting today’s cancellation using yesterday’s cancellation data (You can use Regression). What is the value of this improvement based on the data, i.e., if a consultant comes and provides this forecast algorithm to you, how much are you willing to pay?**


```{r}

yesterday <- data[1:729,]
today <- data[2:730,]
twoday <- data.frame(yesterday = yesterday, today = today)
ggplot(data = twoday, aes(x = yesterday, y = today))+
  geom_jitter()
corr_coef <- cor(twoday$yesterday, twoday$today)
print(paste('Correlation Coefficient of cancellations in subsequent two days is', corr_coef))
```

```{r}
lm.predict <- lm(today~yesterday, data=twoday)
summary(lm.predict)
results.df <- tidy(lm.predict,conf.int = T)
```

So the linear regression model is today = 3.5562 + 0.6746 * yesterday

```{r}
new <- data.frame(yesterday = twoday$yesterday)
twoday$prediction <- predict(lm.predict, newdata=new)
twoday$error <-twoday$today -twoday$prediction
MSE <- mean((twoday$error)**2)
std_error <- sd(twoday$error)
print(paste('The MSE of our prediction is', MSE))
print(paste("The standard deviation of error is", std_error))
```

We will go above the expected value a little bit to balance the understocking cost and overstock cost. The prediction value is a point estimator. The prediction is actually a normal distribution. The mean is the point estimator and the standard deviation is just the standard deviation of error term. We will choose the predicted overbooking amount according to our 70.588% target service level. So we need to add a 71% quantile to the point estimator. 

```{r}
k <- qnorm(0.71,mean=0,sd=4.06)
twoday <- twoday%>%
  mutate(overbook = round(prediction+k))%>%
  mutate(profit = -250*pmax(overbook - today,0)+ifelse(overbook>today, 310*600, 600*(310+pmin(overbook - today, 0))))

lm_exp_profit <- mean(twoday$profit)

print(paste('The expected profit of using linear regression every day is', lm_exp_profit))
diff2 <- lm_exp_profit - total_exp_profit
print(paste('The value of using linear regression is', diff2))
```


